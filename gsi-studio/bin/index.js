const fs = require("fs");

const data = require("../public/base.json");

const template = (json) => {
  return `String styleJSON = '''${JSON.stringify(json)}''';`;
};

const key = "gsi-mapbox";

const mixed = {
  version: 8,
  name: "mixed",
  id: key,
  glyphs:
    "https://cyberjapandata.gsi.go.jp/xyz/noto-jp/{fontstack}/{range}.pbf",
  sources: {
    [key + "-vector"]: {
      type: "vector",
      tiles: [
        "https://cyberjapandata.gsi.go.jp/xyz/experimental_bvmap/{z}/{x}/{y}.pbf",
        // "https://cyberjapandata.gsi.go.jp/xyz/experimental_rdcl/{z}/{x}/{y}.geojson",
        // "https://cyberjapandata.gsi.go.jp/xyz/experimental_anno/{z}/{x}/{y}.geojson",
      ],
      maxzoom: 16,
      minzoom: 4,
      attribution:
        "<a href='https://maps.gsi.go.jp/vector/' target='_blank'>地理院地図Vector（仮称）</a>",
    },
    // [key + "-raster"]: {
    //   type: "raster",
    //   tiles: [
    //     "https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png",
    //     // 'https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png',
    //     // 'https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png',
    //   ],
    //   tileSize: 256,
    //   attribution:
    //     "<a href='https://maps.gsi.go.jp/' target='_blank'>地理院地図</a>",
    // },
  },
  layers: [
    {
      id: "background",
      type: "background",
      paint: {
        "background-color": "rgba(255, 255, 255, 1)",
      },
    },
    // {
    //   'id': key + '-raster',
    //   'type': 'raster',
    //   'source': key + '-raster',
    //   'minzoom': 0,
    //   'maxzoom': 22
    // },
  ],
};

const base = mixed;

function analyzeStyle(style, options) {
  const typeSet = new Set();
  const sourceLayerSet = new Set();
  const pathSet = new Set();
  const titleSet = new Set();
  const overview = {};
  const dataset = {};

  style.layers.forEach((layer) => {
    const type = layer.type;
    const sourceLayer = layer["source-layer"];
    const path = layer.metadata ? layer.metadata.path : "";
    const title = layer.metadata ? layer.metadata.title : "";

    typeSet.add(type);
    sourceLayerSet.add(sourceLayer);
    pathSet.add(path);
    titleSet.add(title);

    if (dataset[sourceLayer]) {
      dataset[sourceLayer].push(layer);
    } else {
      dataset[sourceLayer] = [layer];
    }

    if (overview[type] && overview[type][sourceLayer]) {
      overview[type][sourceLayer].push({ path, title });
    } else {
      if (overview[type]) {
        overview[type][sourceLayer] = [{ path, title }];
      } else {
        overview[type] = {
          [layer["source-layer"]]: [{ path, title }],
        };
      }
    }

    if (options.filename) {
      fs.writeFileSync(
        `./public/${options.filename}`,
        JSON.stringify({
          types: Array.from(typeSet),
          sourceLayers: Array.from(sourceLayerSet),
          paths: Array.from(pathSet),
          titles: Array.from(titleSet),
          overview,
          dataset,
        })
      );
    }
  });
}

function layerFilter(layer) {
  const blockSourceLayers = [
    "landformp",
    "structurel",
    "river",
    "waterarea",
    "lake",
    "landforml",
    "landforma",
    "coastline",
    // "contour",
    "wstructurea",
    "structurea",
    // "symbol",
    "searoute",
    "boundary",
    "building",
    "road",
    "railway",
    // "elevation",
    // "label",
    "transp",
  ];
  const blockTypes = [
    // "background",
    // "line",
    // "fill",
    // "symbol",
  ];
  const blockPaths = [
    // "等高線等深線-等深線-通常部",
    // "等高線等深線-等深線-崖部",
    // "等高線等深線-等深線-計曲線通常部",
    // "等高線等深線-等深線-主曲線通常部",
    // "等高線等深線-等深線-補助曲線通常部",
    // "等高線等深線-等深線-数値部",
    // "等高線等深線-等深線-計曲線崖部",
    // "等高線等深線-等高線-通常部",
    // "等高線等深線-等高線-崖部",
    // "等高線等深線-等高線-計曲線通常部",
    // "等高線等深線-等高線-主曲線通常部",
    // "等高線等深線-等高線-補助曲線通常部",
    // "等高線等深線-等高線-数値部",
    // "等高線等深線-等高線-計曲線崖部",
    // "記号-墓地",
    // "記号-田",
    // "記号-畑",
    // "記号-茶畑",
    // "記号-果樹園",
    // "記号-広葉樹林",
    // "記号-針葉樹林",
    // "記号-竹林",
    // "記号-ヤシ科樹林",
    // "記号-ハイマツ地",
    // "記号-笹地",
    // "記号-荒地",
    // "標高-標高点",
    // "標高-標高点（測点）",
    // "標高-火山-火山（アイコン）",
    // "標高-火山-火山（標高）",
    // "標高-水面標高",
    // "標高-水深",
    // "記号-主要な港",
    // "記号-主要な空港",
    // "記号-都道府県所在地",
    // "記号-市役所・東京都の区役所（都道府県所在都市以外）",
    // "記号-町・村",
    // "記号-官公署",
    // "記号-裁判所",
    // "記号-税務署",
    // "記号-外国公館",
    // "記号-市役所・東京都の区役所",
    // "記号-町村役場・政令指定都市の区役所",
    // "記号-警察署",
    // "記号-交番",
    // "記号-消防署",
    // "記号-高等学校・中等教育学校",
    // "記号-中学校",
    // "記号-小学校",
    // "記号-病院",
    // "記号-保健所",
    // "記号-老人ホーム",
    // "記号-博物館法の登録博物館・博物館相当施設",
    // "記号-図書館",
    // "記号-郵便局",
    // "記号-灯台",
    // "記号-寺院",
    // "記号-工場",
    // "記号-煙突",
    // "記号-風車",
    // "記号-油井・ガス井",
    // "記号-記念碑",
    // "記号-自然災害伝承碑",
    // "記号-温泉",
    // "記号-噴火口・噴気口",
    // "記号-史跡・名勝・天然記念物",
    // "記号-城跡",
    // "記号-採鉱地",
    // "記号-港湾",
    // "記号-漁港",
    // "記号-飛行場",
    // "記号-自衛隊等の飛行場",
    // "記号-自衛隊",
    // "記号-特定重要港",
    // "記号-重要港",
    // "記号-国際空港",
    // "記号-国際空港以外の拠点空港等",
    // "記号-発電所等",
    // "記号-電波塔",
    // "記号-人口50万人未満",
    // "記号-人口50万～100万人未満",
    // "記号-人口100万人以上",
    // "注記-その他",
    // "注記-鉱山の鉱種名",
    // "注記-料金所",
    // "注記-発電所",
    // "注記-学校",
    // "注記-特殊学校",
    // "注記-高等専門学校",
    // "注記-短期大学",
    // "注記-大学・大学院",
    // "注記-県庁",
    // "注記-漁港",
    // "注記-VLBI観測点",
    // "注記-その他の主要・著名な建物",
    // "注記-指定公共機関",
    // "注記-文教施設",
    // "注記-高層施設",
    // "注記-商業施設",
    // "注記-寺院",
    // "注記-神社",
    // "注記-外国公館",
    // "注記-博物館",
    // "注記-水族館・動植物園",
    // "注記-郵便局",
    // "注記-保健所",
    // "注記-病院",
    // "注記-消防",
    // "注記-消防署",
    // "注記-警察",
    // "注記-自衛隊・米軍",
    // "注記-整備局（北海道開発局・地方整備局）",
    // "注記-矯正施設（刑務所、少年院等）",
    // "注記-地方の機関",
    // "注記-国の機関",
    // "注記-国の機関（合同庁舎、矯正施設及び自衛隊を除く）",
    // "注記-合同庁舎",
    // "注記-公園",
    // "注記-公園-小",
    // "注記-公園-中",
    // "注記-公園-大",
    // "注記-史跡名勝天然記念物",
    // "注記-土地利用名（演習場、ゴルフ場、遊園地、建設予定地等）",
    // "注記-土地利用名（演習場、ゴルフ場、遊園地、建設予定地等）-小",
    // "注記-土地利用名（演習場、ゴルフ場、遊園地、建設予定地等）-中",
    // "注記-土地利用名（演習場、ゴルフ場、遊園地、建設予定地等）-大",
    // "注記-河川・海岸施設（水門、堤防）",
    // "注記-堰",
    // "注記-ダム",
    // "注記-構造物名称（高塔、煙突等）",
    // "注記-空港名",
    // "注記-飛行場名-小",
    // "注記-飛行場名-中",
    // "注記-飛行場名-大",
    // "注記-港湾施設（フェリー発着所、埠頭等）",
    // "注記-港湾",
    // "注記-港湾-小",
    // "注記-港湾-中",
    // "注記-港湾-大",
    // "注記-鉄道構造物（橋、トンネル、操車場等）",
    // "注記-鉄道駅名",
    // "注記-鉄道路線名",
    // "注記-道路構造物（橋、トンネル等）",
    // "注記-道路施設名（道の駅、IC、SA等）",
    // "注記-道の駅",
    // "注記-道路名",
    // "注記-到達注記",
    // "注記-はえ、岩礁等",
    // "注記-はえ、岩礁等-小",
    // "注記-はえ、岩礁等-中",
    // "注記-はえ、岩礁等-大",
    // "注記-島",
    // "注記-島-小",
    // "注記-島-中",
    // "注記-島-大",
    // "注記-群島、列島、島の総称等",
    // "注記-群島、列島、諸島、島の総称等-小",
    // "注記-群島、列島、諸島、島の総称等-中",
    // "注記-群島、列島、諸島、島の総称等-大",
    // "注記-諸島、群島、列島、島の総称等",
    // "注記-岬、崎、鼻",
    // "注記-岬、鼻、崎、磯、敷等",
    // "注記-岬、鼻、崎、磯、敷等-小",
    // "注記-岬、鼻、崎、磯、敷等-中",
    // "注記-岬、鼻、崎、磯、敷等-大",
    // "注記-海岸、浜、磯",
    // "注記-海岸、浜、半島",
    // "注記-海岸、浜、洲、干潟-小",
    // "注記-海岸、浜、洲、干潟-中",
    // "注記-海岸、浜、洲、干潟-大",
    // "注記-海岸、浜、洲、干潟",
    // "注記-半島-小",
    // "注記-半島-中",
    // "注記-半島-大",
    // "注記-半島",
    // "注記-湾、灘",
    // "注記-海峡、水道",
    // "注記-海、湾、灘、淵、浦、瀬、海峡、瀬戸等",
    // "注記-湾、淵、浦、瀬、海峡、瀬戸等-小",
    // "注記-湾、淵、浦、瀬、海峡、瀬戸等-中",
    // "注記-湾、淵、浦、瀬、海峡、瀬戸等-大",
    // "注記-湾、淵、浦、瀬、海峡、瀬戸等、水道",
    // "注記-海山、海嶺、海盆等",
    // "注記-海、灘-小",
    // "注記-海、灘-中",
    // "注記-海、灘-大",
    // "注記-海、灘",
    // "注記-岩、洞窟",
    // "注記-峠",
    // "注記-温泉、泉、噴気口",
    // "注記-岩、溶岩、崖、鍾乳洞、温泉、湧水、噴泉、噴火口、峠、坂等",
    // "注記-岩、溶岩、崖、鍾乳洞、温泉、湧水、噴泉、噴火口、峠、坂等-小",
    // "注記-岩、溶岩、崖、鍾乳洞、温泉、湧水、噴泉、噴火口、峠、坂等-中",
    // "注記-岩、溶岩、崖、鍾乳洞、温泉、湧水、噴泉、噴火口、峠、坂等-大",
    // "注記-高原、平原、湿原",
    // "注記-高原、原、森、林、砂丘、湿原",
    // "注記-高原、原、森、林、平、砂丘、湿原-小",
    // "注記-高原、原、森、林、平、砂丘、湿原-中",
    // "注記-高原、原、森、林、平、砂丘、湿原-大",
    // "注記-高原、原、森、林、平、砂丘、湿原",
    // "注記-平野、盆地-小",
    // "注記-平野、盆地-中",
    // "注記-平野、盆地-大",
    // "注記-平野、盆地",
    // "注記-山脈、山地-小",
    // "注記-山脈、山地-中",
    // "注記-山脈、山地-大",
    // "注記-山脈、山地",
    // "注記-滝",
    // "注記-沢、瀬、淵、瀞、谷、峡、雪渓、河原、州、滝、浜、崎、半島、尻、島等",
    // "注記-沢、瀬、淵、瀞、谷、峡、雪渓、河原、州、滝、浜、崎、半島、尻、島等-小",
    // "注記-沢、瀬、淵、瀞、谷、峡、雪渓、河原、州、滝、浜、崎、半島、尻、島等-中",
    // "注記-沢、瀬、淵、瀞、谷、峡、雪渓、河原、州、滝、浜、崎、半島、尻、島等-大",
    // "注記-河川、用水等",
    // "注記-河川、用水等-小",
    // "注記-河川、用水等-中",
    // "注記-河川、用水等-大",
    // "注記-湖沼",
    // "注記-湖、沼、池、浦等",
    // "注記-湖、沼、池、浦等-小",
    // "注記-湖、沼、池、浦等-中",
    // "注記-湖、沼、池、浦等-大",
    // "注記-尖峰、丘、塚等",
    // "注記-山",
    // "注記-山、岳、峰等",
    // "注記-山、岳、峰等-小",
    // "注記-山、岳、峰等-中",
    // "注記-山、岳、峰等-大",
    // "注記-山、岳、峰等（１０００ｍ未満）",
    // "注記-山、岳、峰等（１０００ｍ以上）",
    // "注記-山、岳、峰等（３０００ｍ以上）",
    // "注記-山の総称",
    // "注記-山の総称-小",
    // "注記-山の総称-中",
    // "注記-山の総称-大",
    // "注記-居住地名（大字・町・丁目）",
    // "注記-集落名称（通称）",
    // "注記-公称（町字名）",
    // "注記-市街地",
    // "注記-郡",
    // "注記-飛び地",
    // "注記-都道府県",
    // "注記-市区町村",
    // "注記-山地名、山脈名、平原名",
    // "注記-山名",
    // "注記-岬・崎名",
    // "注記-半島名",
    // "注記-河川名",
    // "注記-湖沼名",
    // "注記-島名",
    // "注記-諸島・群島・列島名",
    // "注記-海底地形名",
    // "注記-湾・海峡",
    // "注記-海域名",
    // "注記-地方名",
    // "注記-国名",
    // "記号-都道府県庁",
    // "記号-北海道の総合振興局・振興局",
    // "記号-支庁",
    // "記号-大学",
    // "記号-短期大学",
    // "記号-高等専門学校",
    // "記号-神社",
    // "記号-三角点",
    // "記号-水準点",
    // "記号-電子基準点",
    // "記号-電子基準点(付)",
  ];
  const blockTitles = [
    "通常部",
    "崖部",
    "計曲線通常部",
    "主曲線通常部",
    "補助曲線通常部",
    "数値部",
    "計曲線崖部",
    "墓地",
    "田",
    "畑",
    "茶畑",
    "果樹園",
    "広葉樹林",
    "針葉樹林",
    "竹林",
    "ヤシ科樹林",
    "ハイマツ地",
    "笹地",
    "荒地",
    "標高点",
    "標高点（測点）",
    "火山（アイコン）",
    "火山（標高）",
    "水面標高",
    "水深",
    "主要な港",
    "主要な空港",
    "都道府県所在地",
    "市役所・東京都の区役所（都道府県所在都市以外）",
    "町・村",
    "官公署",
    "裁判所",
    "税務署",
    "外国公館",
    "市役所・東京都の区役所",
    "町村役場・政令指定都市の区役所",
    "警察署",
    "交番",
    "消防署",
    "高等学校・中等教育学校",
    "中学校",
    "小学校",
    "病院",
    "保健所",
    "老人ホーム",
    "博物館法の登録博物館・博物館相当施設",
    "図書館",
    "郵便局",
    "灯台",
    "寺院",
    "工場",
    "煙突",
    "風車",
    "油井・ガス井",
    "記念碑",
    "自然災害伝承碑",
    "温泉",
    "噴火口・噴気口",
    "史跡・名勝・天然記念物",
    "城跡",
    "採鉱地",
    "港湾",
    "漁港",
    "飛行場",
    "自衛隊等の飛行場",
    "自衛隊",
    "特定重要港",
    "重要港",
    "国際空港",
    "国際空港以外の拠点空港等",
    "発電所等",
    "電波塔",
    "人口50万人未満",
    "人口50万～100万人未満",
    "人口100万人以上",
    "その他",
    "鉱山の鉱種名",
    "料金所",
    "発電所",
    "学校",
    "特殊学校",
    "高等専門学校",
    "短期大学",
    "大学・大学院",
    "県庁",
    "VLBI観測点",
    "その他の主要・著名な建物",
    "指定公共機関",
    "文教施設",
    "高層施設",
    "商業施設",
    "神社",
    "博物館",
    "水族館・動植物園",
    "消防",
    "警察",
    "自衛隊・米軍",
    "整備局（北海道開発局・地方整備局）",
    "矯正施設（刑務所、少年院等）",
    "地方の機関",
    "国の機関",
    "国の機関（合同庁舎、矯正施設及び自衛隊を除く）",
    "合同庁舎",
    "公園",
    "小",
    "中",
    "大",
    "史跡名勝天然記念物",
    "土地利用名（演習場、ゴルフ場、遊園地、建設予定地等）",
    "河川・海岸施設（水門、堤防）",
    "堰",
    "ダム",
    "構造物名称（高塔、煙突等）",
    "空港名",
    "港湾施設（フェリー発着所、埠頭等）",
    "鉄道構造物（橋、トンネル、操車場等）",
    "鉄道駅名",
    "鉄道路線名",
    "道路構造物（橋、トンネル等）",
    "道路施設名（道の駅、IC、SA等）",
    "道の駅",
    "道路名",
    "到達注記",
    "はえ、岩礁等",
    "島",
    "群島、列島、島の総称等",
    "諸島、群島、列島、島の総称等",
    "岬、崎、鼻",
    "岬、鼻、崎、磯、敷等",
    "海岸、浜、磯",
    "海岸、浜、半島",
    "海岸、浜、洲、干潟",
    "半島",
    "湾、灘",
    "海峡、水道",
    "海、湾、灘、淵、浦、瀬、海峡、瀬戸等",
    "湾、淵、浦、瀬、海峡、瀬戸等、水道",
    "海山、海嶺、海盆等",
    "海、灘",
    "岩、洞窟",
    "峠",
    "温泉、泉、噴気口",
    "岩、溶岩、崖、鍾乳洞、温泉、湧水、噴泉、噴火口、峠、坂等",
    "高原、平原、湿原",
    "高原、原、森、林、砂丘、湿原",
    "高原、原、森、林、平、砂丘、湿原",
    "平野、盆地",
    "山脈、山地",
    "滝",
    "沢、瀬、淵、瀞、谷、峡、雪渓、河原、州、滝、浜、崎、半島、尻、島等",
    "河川、用水等",
    "湖沼",
    "湖、沼、池、浦等",
    "尖峰、丘、塚等",
    // "山",
    // "山、岳、峰等",
    // "山、岳、峰等（１０００ｍ未満）",
    // "山、岳、峰等（１０００ｍ以上）",
    // "山、岳、峰等（３０００ｍ以上）",
    // "山の総称",
    "居住地名（大字・町・丁目）",
    "集落名称（通称）",
    "公称（町字名）",
    "市街地",
    "郡",
    "飛び地",
    "都道府県",
    "市区町村",
    "山地名、山脈名、平原名",
    "山名",
    "岬・崎名",
    "半島名",
    "河川名",
    "湖沼名",
    "島名",
    "諸島・群島・列島名",
    "海底地形名",
    "湾・海峡",
    "海域名",
    "地方名",
    "国名",
    "都道府県庁",
    "北海道の総合振興局・振興局",
    "支庁",
    "大学",
    "三角点",
    "水準点",
    "電子基準点",
    "電子基準点(付)",
  ];

  if (blockSourceLayers.indexOf(layer["source-layer"]) !== -1) {
    return false;
  }
  if (blockTypes.indexOf(layer["type"]) !== -1) {
    return false;
  }
  if (layer.metadata && blockPaths.indexOf(layer.metadata.path) !== -1) {
    return false;
  }
  if (layer.metadata && blockTitles.indexOf(layer.metadata.title) !== -1) {
    return false;
  }
  return true;
}

function transform(layer) {
  layer.source = key + "-vector";
  // console.log(layer.metadata);

  // delete layer.metadata;
  // layer.minzoom = 4;
  // layer.maxzoom = 16;
  return layer;
}

analyzeStyle(data, { filename: "raw.json" });
base.layers = base.layers.concat(
  data.layers.filter(layerFilter).map(transform)
);
analyzeStyle(base, { filename: "dataset.json" });

fs.writeFileSync("./public/preview.json", JSON.stringify(base));
fs.writeFileSync("../lib/components/map_body_style_json.dart", template(base));
